<!doctype html>
<html lang="es">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Grabadora de Recetas</title>
<style>
  :root { color-scheme: light; }
  body { font-family: system-ui, Arial, "Segoe UI"; margin: 20px; background:#fafafa; }
  .card { max-width: 560px; margin: auto; padding: 18px; background:#fff; border:1px solid #e5e5e5; border-radius: 14px; box-shadow: 0 2px 24px rgba(0,0,0,0.04); }
  h2 { margin: 0 0 8px; }
  p.help { margin: 0 0 14px; color:#555; }
  label { display:block; margin: 10px 0 6px; font-weight: 600; }
  input, textarea, button { width:100%; padding:12px; border:1px solid #ccc; border-radius:10px; font-size:15px; }
  input:focus, textarea:focus, button:focus { outline: 3px solid #e6f0ff; border-color:#80aaff; }
  .row { display:flex; gap:10px; }
  .row > * { flex:1 }
  .pill { display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid #ddd; background:#fff; font-size:13px; color:#444; }
  .muted { color:#666; font-size: 13px; }
  .ok { color:#096; }
  .err { color:#900; }
  .actions { display:flex; gap:10px; margin-top: 12px; }
  .tip { font-size: 12px; color:#666; margin-top: 8px; }
</style>

<div class="card">
  <h2>Grabadora de Recetas</h2>
  <p class="help">Graba la receta y env√≠ala al sistema. Capturamos <b>Nombre</b>, <b>Tel√©fono</b> y el <b>Audio</b>.</p>

  <!-- NUEVO: contador de pacientes y switch -->
  <div class="row" style="align-items:center; margin:6px 0 10px">
    <span id="pacienteIdx" class="pill">Paciente #1</span>
    <label class="pill" style="display:flex; gap:8px; align-items:center; cursor:pointer">
      <input id="autoReset" type="checkbox" checked />
      Autolimpiar
    </label>
  </div>

  <label>Nombre completo del paciente</label>
  <input id="paciente" placeholder="Ej: Jos√© Fernando Quijivix" required />

  <label>Tel√©fono (WhatsApp, formato +502########)</label>
  <input id="telefono" placeholder="+502XXXXXXXX" required />

  <label>Diagn√≥stico (opcional)</label>
  <input id="diagnostico" placeholder="Acn√©, dermatitis..." />

  <div style="margin:10px 0">
    <span id="estado" class="pill">Listo para grabar</span>
  </div>

  <div class="actions">
    <button id="btnRec">üéôÔ∏è Iniciar grabaci√≥n</button>
    <button id="btnStop" disabled>‚èπÔ∏è Detener y enviar</button>
  </div>

  <p id="msg" class="muted"></p>
  <p class="tip">Permite el acceso al micr√≥fono. En iPhone/Safari, debe estar en HTTPS (GitHub Pages ya lo es).</p>
</div>

<script>
// ===== CONFIG =====
const WEBHOOK = "https://nextgen-ai-jq.app.n8n.cloud/webhook/recetas-audio"; // tu webhook n8n
const DEFAULT_CC = "+502"; // prefijo inicial de tel√©fono

// ===== helpers =====
const $ = (id) => document.getElementById(id);
const pacienteEl   = $('paciente');
const telefonoEl   = $('telefono');
const diagnosticoEl= $('diagnostico');
const btnRec       = $('btnRec');
const btnStop      = $('btnStop');
const estado       = $('estado');
const msg          = $('msg');
const pacienteIdx  = $('pacienteIdx');
const autoResetEl  = $('autoReset');

let idx = 1;
let mediaRecorder, chunks = [];
let chosenMime = null;
let fileExt = 'webm';

// Validar tel√©fono en formato E.164
const validarTelefonoE164 = (t) => /^\+[1-9]\d{7,14}$/.test(t);

// Elegir MIME compatible
function pickMimeType() {
  const candidates = [
    { mime: 'audio/webm;codecs=opus', ext: 'webm' },
    { mime: 'audio/webm',            ext: 'webm' },
    { mime: 'audio/mp4',             ext: 'm4a'  },
    { mime: 'audio/ogg;codecs=opus', ext: 'ogg'  },
    { mime: 'audio/ogg',             ext: 'ogg'  },
    { mime: 'audio/wav',             ext: 'wav'  },
  ];
  for (const c of candidates) {
    if (window.MediaRecorder?.isTypeSupported?.(c.mime)) {
      chosenMime = c.mime; fileExt = c.ext; return;
    }
  }
  chosenMime = null;
}
pickMimeType();

// Resetear para siguiente paciente
function resetForNextPatient() {
  if (!autoResetEl.checked) return;
  idx += 1;
  pacienteIdx.textContent = `Paciente #${idx}`;
  pacienteEl.value = '';
  telefonoEl.value = DEFAULT_CC;
  diagnosticoEl.value = '';
  estado.textContent = 'Listo para grabar';
  msg.textContent = '';
  btnRec.disabled = false;
  btnStop.disabled = true;
  pacienteEl.focus();
}

// ===== flujo =====
btnRec.onclick = async () => {
  const nombre   = pacienteEl.value.trim();
  const telefono = telefonoEl.value.trim();

  if (!nombre) { alert('Ingresa el nombre completo del paciente.'); pacienteEl.focus(); return; }
  if (!validarTelefonoE164(telefono)) { alert('Tel√©fono inv√°lido. Usa formato +502XXXXXXXX.'); telefonoEl.focus(); return; }
  if (!navigator.mediaDevices?.getUserMedia) { alert('Tu navegador no soporta grabaci√≥n.'); return; }
  if (!chosenMime) { alert('Formato de audio no soportado.'); return; }

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    chunks = [];
    mediaRecorder = new MediaRecorder(stream, { mimeType: chosenMime });
    mediaRecorder.ondataavailable = (e) => { if (e.data?.size > 0) chunks.push(e.data); };
    mediaRecorder.onstart = () => { estado.textContent = `Grabando (Paciente #${idx})...`; };

    mediaRecorder.onstop = async () => {
      try {
        estado.textContent = 'Procesando...';
        const blob = new Blob(chunks, { type: chosenMime });
        const fileName = `receta_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.${fileExt}`;
        const file = new File([blob], fileName, { type: chosenMime });

        const fd = new FormData();
        fd.append('audio', file);
        fd.append('paciente', nombre);
        fd.append('telefono', telefono);
        fd.append('diagnostico', diagnosticoEl.value.trim());

        btnRec.disabled = true;
        btnStop.disabled = true;

        const res = await fetch(WEBHOOK, { method: 'POST', body: fd });
        if (!res.ok) throw new Error('El servidor respondi√≥ con error');

        estado.textContent = 'Enviado ‚úÖ';
        msg.innerHTML = '<span class="ok">Listo. El audio se envi√≥ al sistema.</span>';

        // üëâ reseteo para siguiente paciente
        resetForNextPatient();

      } catch (e) {
        estado.textContent = 'Error al enviar';
        msg.innerHTML = `<span class="err">${e.message || e}</span>`;
        btnRec.disabled = false;
        btnStop.disabled = true;
      }
    };

    mediaRecorder.start();
    btnRec.disabled = true;
    btnStop.disabled = false;

  } catch (e) {
    alert('No se pudo acceder al micr√≥fono. Revisa permisos/HTTPS.');
    console.error(e);
  }
};

btnStop.onclick = () => {
  if (mediaRecorder?.state === 'recording') {
    mediaRecorder.stop();
    estado.textContent = 'Deteniendo...';
    btnStop.disabled = true;
  }
};

// Estado inicial
if (!telefonoEl.value) telefonoEl.value = DEFAULT_CC;
pacienteEl.focus();
</script>
</html>

