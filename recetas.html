<!doctype html>
<html lang="es">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Grabadora de Recetas</title>
<style>
  :root { color-scheme: light; }
  body { font-family: system-ui, Arial, "Segoe UI"; margin: 20px; background:#fafafa; }
  .card { max-width: 560px; margin: auto; padding: 18px; background:#fff; border:1px solid #e5e5e5; border-radius: 14px; box-shadow: 0 2px 24px rgba(0,0,0,0.04); }
  h2 { margin: 0 0 8px; }
  p.help { margin: 0 0 14px; color:#555; }
  label { display:block; margin: 10px 0 6px; font-weight: 600; }
  input, textarea, button { width:100%; padding:12px; border:1px solid #ccc; border-radius:10px; font-size:15px; }
  input:focus, textarea:focus, button:focus { outline: 3px solid #e6f0ff; border-color:#80aaff; }
  .row { display:flex; gap:10px; }
  .row > * { flex:1 }
  .pill { display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid #ddd; background:#fff; font-size:13px; color:#444; }
  .muted { color:#666; font-size: 13px; }
  .ok { color:#096; font-weight: bold; }
  .err { color:#900; }
  .actions { display:flex; gap:10px; margin-top: 12px; flex-wrap:wrap; }
  .tip { font-size: 12px; color:#666; margin-top: 8px; }
  #timer { font-weight: bold; margin-left: 10px; }
  .recording { color: red; animation: blink 1s step-start infinite; }
  @keyframes blink { 50% { opacity: 0; } }
  .small-input { width: 80px; text-align: center; }
</style>

<div class="card">
  <h2>Grabadora de Recetas</h2>
  <p class="help">Graba la receta y env√≠ala al sistema. Capturamos <b>Nombre</b>, <b>Apellido</b>, <b>Tel√©fono</b> y el <b>Audio</b>.</p>

  <div class="row" style="align-items:center; margin:6px 0 10px">
    <span id="pacienteIdx" class="pill">Paciente #1</span>
    <label class="pill" style="display:flex; gap:8px; align-items:center; cursor:pointer">
      <input id="autoReset" type="checkbox" checked />
      Autolimpiar
    </label>
  </div>

  <div class="row">
    <div>
      <label>Nombre</label>
      <input id="nombre" placeholder="Ej: Jos√©" required />
    </div>
    <div>
      <label>Apellido</label>
      <input id="apellido" placeholder="Ej: Quijivix" required />
    </div>
  </div>

  <label>Tel√©fono</label>
  <div class="row">
    <input id="codigo" class="small-input" value="+502" maxlength="5" required />
    <input id="telefono" placeholder="3022-4593" maxlength="9" required />
  </div>

  <label>Diagn√≥stico (opcional)</label>
  <input id="diagnostico" placeholder="Acn√©, dermatitis..." />

  <div style="margin:10px 0">
    <span id="estado" class="pill">Listo para grabar</span>
    <span id="timer"></span>
  </div>

  <div class="actions">
    <button id="btnRec">üéôÔ∏è Iniciar grabaci√≥n</button>
    <button id="btnStop" disabled>‚èπÔ∏è Detener</button>
    <button id="btnReset" disabled>üîÑ Reiniciar</button>
    <button id="btnSend" disabled>üì§ Enviar</button>
  </div>

  <p id="msg" class="muted"></p>
  <p class="tip">Permite el acceso al micr√≥fono. En iPhone/Safari, debe estar en HTTPS (GitHub Pages ya lo es).</p>
</div>

<script>
const WEBHOOK = "https://nextgen-ai-jq.app.n8n.cloud/webhook/recetas-audio"; 

const $ = (id) => document.getElementById(id);
const nombreEl = $('nombre');
const apellidoEl = $('apellido');
const codigoEl = $('codigo');
const telefonoEl = $('telefono');
const diagnosticoEl = $('diagnostico');
const btnRec = $('btnRec');
const btnStop = $('btnStop');
const btnReset = $('btnReset');
const btnSend = $('btnSend');
const estado = $('estado');
const msg = $('msg');
const pacienteIdx = $('pacienteIdx');
const autoResetEl = $('autoReset');
const timerEl = $('timer');

let idx = 1;
let mediaRecorder, chunks = [];
let chosenMime = null;
let fileExt = 'webm';
let audioFile = null;
let timer, seconds = 0;

// ---- Tel√©fono con guion autom√°tico ----
telefonoEl.addEventListener("input", (e) => {
  let val = telefonoEl.value.replace(/\D/g, ""); // solo n√∫meros
  if (val.length > 4) {
    telefonoEl.value = val.slice(0,4) + "-" + val.slice(4,8);
  } else {
    telefonoEl.value = val;
  }
});

// ---- Timer ----
function startTimer() {
  seconds = 0;
  timerEl.textContent = "0:00";
  timerEl.classList.add("recording");
  timer = setInterval(() => {
    seconds++;
    let m = Math.floor(seconds / 60);
    let s = (seconds % 60).toString().padStart(2,'0');
    timerEl.textContent = `${m}:${s}`;
  }, 1000);
}
function stopTimer() { clearInterval(timer); timerEl.classList.remove("recording"); }
function resetTimer() { stopTimer(); timerEl.textContent = ""; }

// ---- Reset paciente ----
function resetForNextPatient() {
  if (!autoResetEl.checked) return;
  idx++;
  pacienteIdx.textContent = `Paciente #${idx}`;
  nombreEl.value = "";
  apellidoEl.value = "";
  codigoEl.value = "+502";
  telefonoEl.value = "";
  diagnosticoEl.value = "";
  estado.textContent = "Listo para grabar";
  btnRec.disabled = false;
  btnStop.disabled = true;
  btnReset.disabled = true;
  btnSend.disabled = true;
  audioFile = null;
  resetTimer();
  nombreEl.focus();
}

// ---- Grabaci√≥n ----
function pickMimeType() {
  const candidates = [
    { mime: 'audio/webm;codecs=opus', ext: 'webm' },
    { mime: 'audio/webm', ext: 'webm' },
    { mime: 'audio/mp4', ext: 'm4a' },
    { mime: 'audio/ogg;codecs=opus', ext: 'ogg' },
    { mime: 'audio/ogg', ext: 'ogg' },
    { mime: 'audio/wav', ext: 'wav' }
  ];
  for (const c of candidates) {
    if (MediaRecorder.isTypeSupported(c.mime)) {
      chosenMime = c.mime; fileExt = c.ext; return;
    }
  }
  chosenMime = null;
}
pickMimeType();

btnRec.onclick = async () => {
  const nombre = nombreEl.value.trim();
  const apellido = apellidoEl.value.trim();
  const telefono = telefonoEl.value.replace(/\D/g, ""); // limpiar guion

  if (!nombre || !apellido) { alert("Ingresa nombre y apellido."); return; }
  if (telefono.length !== 8) { alert("El tel√©fono debe tener 8 d√≠gitos."); return; }

  if (!navigator.mediaDevices?.getUserMedia) { alert("Tu navegador no soporta grabaci√≥n."); return; }
  if (!chosenMime) { alert("Formato de audio no soportado."); return; }

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    chunks = [];
    mediaRecorder = new MediaRecorder(stream, { mimeType: chosenMime });
    mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) chunks.push(e.data); };
    mediaRecorder.onstart = () => { estado.textContent = `Grabando (Paciente #${idx})...`; startTimer(); };
    mediaRecorder.onstop = () => {
      stopTimer();
      const blob = new Blob(chunks, { type: chosenMime });
      const fileName = `receta_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.${fileExt}`;
      audioFile = new File([blob], fileName, { type: chosenMime });
      estado.textContent = "Grabaci√≥n lista (no enviada)";
      btnSend.disabled = false;
      btnReset.disabled = false;
    };

    mediaRecorder.start();
    btnRec.disabled = true;
    btnStop.disabled = false;
    btnReset.disabled = false;
    btnSend.disabled = true;
  } catch (e) {
    alert("No se pudo acceder al micr√≥fono.");
  }
};

btnStop.onclick = () => {
  if (mediaRecorder?.state === "recording") {
    mediaRecorder.stop();
    estado.textContent = "Grabaci√≥n detenida";
    btnStop.disabled = true;
  }
};

btnReset.onclick = () => {
  audioFile = null;
  estado.textContent = "Grabaci√≥n reiniciada";
  btnRec.disabled = false;
  btnStop.disabled = true;
  btnReset.disabled = true;
  btnSend.disabled = true;
  resetTimer();
};

btnSend.onclick = async () => {
  if (!audioFile) { alert("No hay grabaci√≥n lista."); return; }
  try {
    estado.textContent = "Enviando...";
    const fd = new FormData();
    fd.append("audio", audioFile);
    fd.append("paciente", nombreEl.value.trim() + " " + apellidoEl.value.trim());
    fd.append("telefono", codigoEl.value.trim() + telefonoEl.value.replace(/\D/g,""));
    fd.append("diagnostico", diagnosticoEl.value.trim());

    const res = await fetch(WEBHOOK, { method: "POST", body: fd });
    if (!res.ok) throw new Error("Error al enviar");

    const data = await res.json(); // üëà leemos respuesta de n8n
    if (data.rxLink) {
      estado.textContent = "Redirigiendo al editor...";
      window.location.href = data.rxLink; // üëà redirect autom√°tico
    } else {
      estado.textContent = "Enviado ‚úÖ (sin link)";
      msg.innerHTML = '<span class="ok">‚úÖ El audio se envi√≥ al sistema.</span>';
      setTimeout(() => { resetForNextPatient(); }, 2000);
    }
  } catch (e) {
    estado.textContent = "Error al enviar";
    msg.innerHTML = `<span class="err">${e.message || e}</span>`;
  }
};

nombreEl.focus();
</script>
</html>

